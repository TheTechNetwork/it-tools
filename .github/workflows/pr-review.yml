name: PR Review & Recommendations

on:
  workflow_run:
    workflows: ["ci", "E2E tests", "Node.js CI with pnpm"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  checks: read
  actions: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Get PR Details
        id: pr-info
        run: |
          # Get PR number from workflow_run event
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --json number --jq '.[0].number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}

      - name: PR Summary
        id: pr-summary
        run: |
          echo "## ðŸ“Š PR Summary" > review.md
          echo "" >> review.md

          # Get file change statistics
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | wc -l)
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref || 'main' }}...HEAD | grep -oP '\d+(?= insertion)' || echo "0")
          DELETIONS=$(git diff --shortstat origin/${{ github.base_ref || 'main' }}...HEAD | grep -oP '\d+(?= deletion)' || echo "0")

          echo "**Changes:** $FILES_CHANGED file(s) | **+$ADDITIONS** / **-$DELETIONS** lines" >> review.md
          echo "" >> review.md

          # Categorize changes
          SRC_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '^src/.*\.(ts|tsx|js|jsx|vue)$' | wc -l || echo "0")
          TEST_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' | wc -l || echo "0")
          CONFIG_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '(\.config\.|tsconfig|package\.json|\.eslintrc)' | wc -l || echo "0")
          WORKFLOW_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '\.github/workflows/' | wc -l || echo "0")

          echo "**File Categories:**" >> review.md
          if [ "$SRC_CHANGES" -gt 0 ]; then echo "- ðŸ“ Source code: $SRC_CHANGES file(s)" >> review.md; fi
          if [ "$TEST_CHANGES" -gt 0 ]; then echo "- ðŸ§ª Tests: $TEST_CHANGES file(s)" >> review.md; fi
          if [ "$CONFIG_CHANGES" -gt 0 ]; then echo "- âš™ï¸ Configuration: $CONFIG_CHANGES file(s)" >> review.md; fi
          if [ "$WORKFLOW_CHANGES" -gt 0 ]; then echo "- ðŸ”„ Workflows: $WORKFLOW_CHANGES file(s)" >> review.md; fi
          echo "" >> review.md

      - name: Check Workflow Files
        id: workflow-check
        run: |
          echo "## ðŸ”„ Workflow Analysis" >> review.md
          echo "" >> review.md

          # Check for workflow file changes
          WORKFLOW_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '\.github/workflows/.*\.ya?ml$' || true)

          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "### âš™ï¸ Workflow Files Modified" >> review.md
            echo "" >> review.md

            for workflow in $WORKFLOW_CHANGES; do
              echo "#### \`$workflow\`" >> review.md
              echo "" >> review.md

              if [ -f "$workflow" ]; then
                # Check for common issues
                ISSUES_FOUND=false

                if grep -q 'uses:.*@master' "$workflow"; then
                  echo "- âš ï¸ **Security Warning**: Action uses \`@master\` branch. Pin to a specific SHA for security and reproducibility." >> review.md
                  ISSUES_FOUND=true
                fi

                if grep -q 'uses:.*@main' "$workflow"; then
                  echo "- âš ï¸ **Security Warning**: Action uses \`@main\` branch. Pin to a specific SHA for security and reproducibility." >> review.md
                  ISSUES_FOUND=true
                fi

                # Check for action version updates
                if git diff origin/${{ github.base_ref || 'main' }}...HEAD "$workflow" | grep -E '^\+.*uses:.*@'; then
                  echo "- â„¹ï¸ **Info**: Action versions updated. Verify compatibility with existing workflow." >> review.md
                  ISSUES_FOUND=true
                fi

                # Check for custom secrets
                CUSTOM_SECRETS=$(grep -oP '\$\{\{\s*secrets\.\K[A-Z_]+(?=\s*\}\})' "$workflow" | grep -v '^GITHUB_TOKEN$' || true)
                if [ -n "$CUSTOM_SECRETS" ]; then
                  echo "- ðŸ” **Secrets Required**: This workflow uses custom secrets:" >> review.md
                  echo "$CUSTOM_SECRETS" | while read secret; do
                    echo "  - \`$secret\`" >> review.md
                  done
                  echo "  Ensure these are configured in repository settings." >> review.md
                  ISSUES_FOUND=true
                fi

                # Check for workflow permissions
                if grep -q '^permissions:' "$workflow"; then
                  echo "- âœ… **Good Practice**: Workflow defines explicit permissions (principle of least privilege)." >> review.md
                  ISSUES_FOUND=true
                fi

                # Check for timeout settings
                if ! grep -q 'timeout-minutes:' "$workflow"; then
                  echo "- âš ï¸ **Recommendation**: Consider adding \`timeout-minutes\` to prevent stuck workflows." >> review.md
                  ISSUES_FOUND=true
                fi

                if [ "$ISSUES_FOUND" = false ]; then
                  echo "- âœ… No issues detected" >> review.md
                fi

                echo "" >> review.md
              fi
            done
          else
            echo "No workflow files were modified in this PR." >> review.md
            echo "" >> review.md
          fi

      - name: Check Failed Workflows
        id: workflow-status
        run: |
          echo "## ðŸš¦ Workflow Status Check" >> review.md
          echo "" >> review.md

          # Get workflow runs for this PR
          if [ -n "${{ steps.pr-info.outputs.pr_number }}" ]; then
            # Get all recent workflow runs for this branch
            BRANCH_NAME="${{ steps.pr-info.outputs.head_branch }}"
            ALL_RUNS=$(gh run list \
              --repo ${{ github.repository }} \
              --branch "$BRANCH_NAME" \
              --limit 50 \
              --json conclusion,name,databaseId,url,status,createdAt,workflowName 2>/dev/null || echo "[]")

            # Count by status
            FAILED=$(echo "$ALL_RUNS" | jq '[.[] | select(.conclusion == "failure")] | length')
            SUCCESS=$(echo "$ALL_RUNS" | jq '[.[] | select(.conclusion == "success")] | length')
            IN_PROGRESS=$(echo "$ALL_RUNS" | jq '[.[] | select(.status == "in_progress")] | length')

            if [ "$FAILED" -gt 0 ] || [ "$IN_PROGRESS" -gt 0 ] || [ "$SUCCESS" -gt 0 ]; then
              echo "**Status:** âœ… $SUCCESS passed | âŒ $FAILED failed | â³ $IN_PROGRESS running" >> review.md
              echo "" >> review.md
            fi

            # List failed workflows with details
            FAILED_WORKFLOWS=$(echo "$ALL_RUNS" | jq -r '.[] | select(.conclusion == "failure") | "- âŒ [\(.workflowName)](\(.url)) - Run #\(.databaseId)"' || true)

            if [ -n "$FAILED_WORKFLOWS" ] && [ "$FAILED_WORKFLOWS" != "" ]; then
              echo "### âŒ Failed Workflows" >> review.md
              echo "" >> review.md
              echo "$FAILED_WORKFLOWS" >> review.md
              echo "" >> review.md

              echo "**Common Fixes by Workflow Type:**" >> review.md
              echo "" >> review.md

              # Check which workflows failed and provide specific guidance
              if echo "$ALL_RUNS" | jq -e '.[] | select(.conclusion == "failure" and (.workflowName | contains("ci") or contains("CI")))' > /dev/null 2>&1; then
                echo "**CI Workflow Failed:**" >> review.md
                echo "- Run \`pnpm lint\` - Fix any linting errors" >> review.md
                echo "- Run \`pnpm test\` - Ensure all unit tests pass" >> review.md
                echo "- Run \`pnpm typecheck\` - Fix any TypeScript errors" >> review.md
                echo "- Run \`pnpm build\` - Ensure the build completes successfully" >> review.md
                echo "" >> review.md
              fi

              if echo "$ALL_RUNS" | jq -e '.[] | select(.conclusion == "failure" and (.workflowName | contains("E2E") or contains("e2e")))' > /dev/null 2>&1; then
                echo "**E2E Tests Failed:**" >> review.md
                echo "- Run \`pnpm test:e2e\` locally to reproduce" >> review.md
                echo "- Check for UI regressions or broken user flows" >> review.md
                echo "- Review Playwright traces in the workflow artifacts" >> review.md
                echo "- Ensure test data and fixtures are correct" >> review.md
                echo "" >> review.md
              fi

              if echo "$ALL_RUNS" | jq -e '.[] | select(.conclusion == "failure" and (.workflowName | contains("Node")))' > /dev/null 2>&1; then
                echo "**Node.js CI Failed:**" >> review.md
                echo "- Check for Node version compatibility (testing on 18.x and 20.x)" >> review.md
                echo "- Verify pnpm dependencies are correctly locked" >> review.md
                echo "- Review build output for version-specific errors" >> review.md
                echo "" >> review.md
              fi

              echo "**General Troubleshooting:**" >> review.md
              echo "1. Click the âŒ failed workflow link above to view detailed logs" >> review.md
              echo "2. Look for the first error message in the failed step" >> review.md
              echo "3. Run the failing command locally to reproduce" >> review.md
              echo "4. Check if recent commits introduced the failure" >> review.md
              echo "" >> review.md
            else
              echo "### âœ… All Workflows Passing" >> review.md
              echo "" >> review.md
              echo "Great job! All CI checks are passing." >> review.md
              echo "" >> review.md
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Code Quality Review
        id: code-review
        run: |
          echo "## ðŸ“ Code Quality Analysis" >> review.md
          echo "" >> review.md

          # Check for package.json changes
          if git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -q 'package.json'; then
            echo "### ðŸ“¦ Dependencies" >> review.md
            echo "" >> review.md

            # Show what changed in package.json
            DEPS_ADDED=$(git diff origin/${{ github.base_ref || 'main' }}...HEAD -- package.json | grep -E '^\+\s+"[^"]+":' | grep -v '^\+\+\+' || true)
            DEPS_REMOVED=$(git diff origin/${{ github.base_ref || 'main' }}...HEAD -- package.json | grep -E '^\-\s+"[^"]+":' | grep -v '^\-\-\-' || true)
            DEPS_MODIFIED=$(git diff origin/${{ github.base_ref || 'main' }}...HEAD -- package.json | grep -E '^\+\s+"[^"]+":' | while read line; do
              PKG=$(echo "$line" | grep -oP '"\K[^"]+(?=":)')
              if git diff origin/${{ github.base_ref || 'main' }}...HEAD -- package.json | grep -E "^\-\s+\"$PKG\":" > /dev/null; then
                echo "$line"
              fi
            done || true)

            if [ -n "$DEPS_ADDED" ]; then
              echo "**Added:**" >> review.md
              echo "\`\`\`diff" >> review.md
              echo "$DEPS_ADDED" >> review.md
              echo "\`\`\`" >> review.md
            fi

            if [ -n "$DEPS_REMOVED" ]; then
              echo "**Removed:**" >> review.md
              echo "\`\`\`diff" >> review.md
              echo "$DEPS_REMOVED" >> review.md
              echo "\`\`\`" >> review.md
            fi

            echo "**Checklist:**" >> review.md
            echo "- [ ] Run \`pnpm install\` to update lockfile" >> review.md
            echo "- [ ] Check for breaking changes in updated dependencies" >> review.md
            echo "- [ ] Test affected functionality" >> review.md
            echo "- [ ] Review security advisories for new packages" >> review.md
            echo "" >> review.md
          fi

          # Check for lock file changes
          if git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -q 'pnpm-lock.yaml'; then
            if ! git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -q 'package.json'; then
              echo "### âš ï¸ Lock File Changed Without package.json" >> review.md
              echo "" >> review.md
              echo "- \`pnpm-lock.yaml\` was modified but \`package.json\` wasn't" >> review.md
              echo "- This might indicate a dependency resolution change" >> review.md
              echo "- Verify this was intentional (e.g., from \`pnpm update\`)" >> review.md
              echo "" >> review.md
            fi
          fi

          # Check for test coverage
          SRC_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '^src/.*\.(ts|tsx|js|jsx|vue)$' | grep -v '\.(test|spec)\.' || true)
          TEST_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' || true)

          if [ -n "$SRC_CHANGES" ]; then
            SRC_COUNT=$(echo "$SRC_CHANGES" | wc -l)
            TEST_COUNT=$(echo "$TEST_CHANGES" | wc -l || echo "0")

            echo "### ðŸ§ª Test Coverage" >> review.md
            echo "" >> review.md
            echo "- **Source files changed:** $SRC_COUNT" >> review.md
            echo "- **Test files changed:** $TEST_COUNT" >> review.md
            echo "" >> review.md

            if [ "$TEST_COUNT" -eq 0 ] && [ "$SRC_COUNT" -gt 0 ]; then
              echo "âš ï¸ **Notice:** Source code was modified but no test files were changed." >> review.md
              echo "- Consider adding tests for new functionality" >> review.md
              echo "- Update existing tests if behavior changed" >> review.md
              echo "" >> review.md
            else
              echo "âœ… Tests were updated alongside source code changes." >> review.md
              echo "" >> review.md
            fi
          fi

          # Check for configuration changes
          CONFIG_FILES="tsconfig.json|vite.config.ts|vitest.config.ts|playwright.config.ts|.eslintrc"
          if git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E "$CONFIG_FILES" > /dev/null; then
            echo "### âš™ï¸ Configuration Changes" >> review.md
            echo "" >> review.md

            git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD | grep -E "$CONFIG_FILES" | while read config; do
              echo "**\`$config\` modified:**" >> review.md

              case "$config" in
                *tsconfig*)
                  echo "- Run \`pnpm typecheck\` to validate TypeScript configuration" >> review.md
                  echo "- Check for breaking changes in compiler options" >> review.md
                  ;;
                *vite.config*|*vitest.config*)
                  echo "- Test build process: \`pnpm build\`" >> review.md
                  echo "- Verify dev server: \`pnpm dev\`" >> review.md
                  ;;
                *playwright.config*)
                  echo "- Test E2E configuration: \`pnpm test:e2e\`" >> review.md
                  ;;
                *eslint*)
                  echo "- Run \`pnpm lint\` to verify linting configuration" >> review.md
                  echo "- Check for new linting errors in existing code" >> review.md
                  ;;
              esac
              echo "" >> review.md
            done
          fi

      - name: Dynamic Checklist
        id: dynamic-checklist
        run: |
          echo "## âœ… Pre-Merge Checklist" >> review.md
          echo "" >> review.md

          if [ -n "${{ steps.pr-info.outputs.pr_number }}" ]; then
            # Get PR details
            PR_DATA=$(gh pr view ${{ steps.pr-info.outputs.pr_number }} --json mergeable,reviewDecision,commits 2>/dev/null || echo '{}')

            # Check workflow status - use branch from pr-info
            BRANCH_NAME="${{ steps.pr-info.outputs.head_branch }}"
            ALL_RUNS=$(gh run list \
              --repo ${{ github.repository }} \
              --branch "$BRANCH_NAME" \
              --limit 50 \
              --json conclusion,workflowName,status,createdAt 2>/dev/null || echo "[]")

            # Check each required workflow (get most recent run of each type)
            # Sort by createdAt and get the first (most recent) for each workflow
            CI_STATUS=$(echo "$ALL_RUNS" | jq -r '[.[] | select(.workflowName == "ci")] | sort_by(.createdAt) | reverse | .[0].conclusion // "not_run"')
            E2E_STATUS=$(echo "$ALL_RUNS" | jq -r '[.[] | select(.workflowName == "E2E tests")] | sort_by(.createdAt) | reverse | .[0].conclusion // "not_run"')
            NODE_STATUS=$(echo "$ALL_RUNS" | jq -r '[.[] | select(.workflowName == "Node.js CI with pnpm")] | sort_by(.createdAt) | reverse | .[0].conclusion // "not_run"')

            # Check reviews
            REVIEW_DECISION=$(echo "$PR_DATA" | jq -r '.reviewDecision // "REVIEW_REQUIRED"')

            # Check merge conflicts
            MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable // "UNKNOWN"')

            echo "### Required" >> review.md

            # CI checks
            if [ "$CI_STATUS" = "success" ] && [ "$E2E_STATUS" = "success" ] && [ "$NODE_STATUS" = "success" ]; then
              echo "- [x] All CI checks pass âœ…" >> review.md
            elif [ "$CI_STATUS" = "not_run" ] || [ "$E2E_STATUS" = "not_run" ] || [ "$NODE_STATUS" = "not_run" ]; then
              echo "- [ ] All CI checks pass (â³ Some workflows haven't run yet)" >> review.md
              echo "  - ci: ${CI_STATUS}" >> review.md
              echo "  - E2E tests: ${E2E_STATUS}" >> review.md
              echo "  - Node.js CI: ${NODE_STATUS}" >> review.md
            else
              echo "- [ ] All CI checks pass" >> review.md
              echo "  - ci: ${CI_STATUS}" >> review.md
              echo "  - E2E tests: ${E2E_STATUS}" >> review.md
              echo "  - Node.js CI: ${NODE_STATUS}" >> review.md
            fi

            # Code review
            if [ "$REVIEW_DECISION" = "APPROVED" ]; then
              echo "- [x] Code has been reviewed and approved" >> review.md
            else
              echo "- [ ] Code has been reviewed by at least one team member" >> review.md
            fi

            # Merge conflicts
            if [ "$MERGEABLE" = "MERGEABLE" ]; then
              echo "- [x] No merge conflicts exist" >> review.md
            elif [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "- [ ] âš ï¸ **Merge conflicts exist** - resolve before merging" >> review.md
            else
              echo "- [ ] No merge conflicts exist" >> review.md
            fi

            # Branch up to date (check commits behind)
            BEHIND=$(gh pr view ${{ steps.pr-info.outputs.pr_number }} --json baseRefName,headRefName --jq '.baseRefName' 2>/dev/null | xargs -I {} git rev-list --count HEAD..origin/{} 2>/dev/null || echo "0")
            if [ "$BEHIND" = "0" ]; then
              echo "- [x] Branch is up to date with \`main\`" >> review.md
            else
              echo "- [ ] Branch is $BEHIND commit(s) behind \`main\` - update before merging" >> review.md
            fi

            echo "" >> review.md
            echo "### Recommended" >> review.md
          else
            echo "### Required" >> review.md
            echo "- [ ] All CI checks pass (ci, E2E tests, Node.js CI)" >> review.md
            echo "- [ ] Code has been reviewed by at least one team member" >> review.md
            echo "- [ ] No merge conflicts exist" >> review.md
            echo "- [ ] Branch is up to date with \`main\`" >> review.md
            echo "" >> review.md
            echo "### Recommended" >> review.md
          fi

          # Static recommended items (can't auto-check these)
          echo "- [ ] Tests added/updated for new functionality" >> review.md
          echo "- [ ] Documentation updated if needed" >> review.md
          echo "- [ ] No console.log or debug code left in" >> review.md
          echo "- [ ] Performance impact considered" >> review.md
          echo "- [ ] Accessibility reviewed (if UI changes)" >> review.md
          echo "" >> review.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Testing Guide
        id: testing-guide
        run: |
          echo "## ðŸ”§ Local Testing Commands" >> review.md
          echo "" >> review.md
          echo "Run these commands locally to catch issues before pushing:" >> review.md
          echo "" >> review.md
          echo "\`\`\`bash" >> review.md
          echo "# Install dependencies" >> review.md
          echo "pnpm install" >> review.md
          echo "" >> review.md
          echo "# Run all checks (recommended before every push)" >> review.md
          echo "pnpm lint        # Check code style" >> review.md
          echo "pnpm typecheck   # Check TypeScript types" >> review.md
          echo "pnpm test        # Run unit tests" >> review.md
          echo "pnpm build       # Build the application" >> review.md
          echo "pnpm test:e2e    # Run E2E tests (optional, takes longer)" >> review.md
          echo "\`\`\`" >> review.md
          echo "" >> review.md

          echo "---" >> review.md
          echo "" >> review.md
          echo "*ðŸ¤– This automated review provides guidance and recommendations. It does not replace human code review and testing. Always verify changes locally before merging.*" >> review.md
          echo "" >> review.md
          echo "<details><summary>ðŸ’¬ Feedback</summary>" >> review.md
          echo "" >> review.md
          echo "If this review was helpful or needs improvement, please provide feedback by:" >> review.md
          echo "- ðŸ‘ Reacting to this comment" >> review.md
          echo "- ðŸ’¬ Leaving a reply with suggestions" >> review.md
          echo "- ðŸ› Opening an issue if you found a bug in the review logic" >> review.md
          echo "" >> review.md
          echo "</details>" >> review.md

      - name: Post Review Comment
        if: steps.pr-info.outputs.pr_number != ''
        run: |
          # Check if we already posted a comment
          EXISTING_COMMENT=$(gh pr view ${{ steps.pr-info.outputs.pr_number }} \
            --json comments \
            --jq '.comments[] | select(.author.login == "github-actions[bot]" and (.body | contains("## ðŸ” Automated PR Review"))) | .id' \
            | head -n 1 || true)

          # Prepare the comment body
          cat > comment.md << 'EOF'
          ## ðŸ” Automated PR Review & Recommendations

          EOF
          cat review.md >> comment.md

          if [ -n "$EXISTING_COMMENT" ]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" \
              -f body="$(cat comment.md)"
          else
            # Post new comment
            gh pr comment ${{ steps.pr-info.outputs.pr_number }} --body-file comment.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
